name: Security Audit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 0'  # Weekly on Sundays

permissions:
  contents: read
  security-events: write

jobs:
  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for vulnerable dependencies
        run: |
          npm audit --json > audit-results.json || true
          cat audit-results.json

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit-results
          path: audit-results.json
          retention-days: 30

  solidity-security:
    name: Solidity Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Run Solhint security checks
        run: npm run lint:sol
        continue-on-error: true

      - name: Compile contracts
        run: npm run compile

      - name: Check for unsafe patterns
        run: |
          echo "Checking for unsafe Solidity patterns..."
          grep -r "tx.origin" contracts/ && echo "âš ï¸  Warning: tx.origin detected" || echo "âœ… No tx.origin usage"
          grep -r "block.timestamp" contracts/ && echo "âš ï¸  Warning: block.timestamp detected" || echo "âœ… No direct timestamp usage"
          grep -r "selfdestruct" contracts/ && echo "âš ï¸  Warning: selfdestruct detected" || echo "âœ… No selfdestruct"
          grep -r "delegatecall" contracts/ && echo "âš ï¸  Warning: delegatecall detected" || echo "âœ… No delegatecall"

  gas-optimization:
    name: Gas Usage Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with gas reporting
        run: npm run test:gas
        env:
          REPORT_GAS: true

      - name: Check contract sizes
        run: npm run size

      - name: Upload gas report
        uses: actions/upload-artifact@v4
        with:
          name: gas-report
          path: gas-report.txt
          retention-days: 30
        continue-on-error: true

  eslint-security:
    name: JavaScript Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint with security plugin
        run: npm run lint:js
        continue-on-error: true

  dos-protection-check:
    name: DoS Protection Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for DoS vulnerabilities
        run: |
          echo "ðŸ” Checking for potential DoS vulnerabilities..."

          echo "Checking for unbounded loops..."
          grep -r "for.*length" contracts/ && echo "âš ï¸  Warning: Potential unbounded loop" || echo "âœ… No unbounded loops detected"

          echo "Checking for gas-heavy operations..."
          grep -r "while.*true" contracts/ && echo "âš ï¸  Warning: Infinite loop potential" || echo "âœ… No infinite loops"

          echo "Checking for external calls in loops..."
          grep -r "\.call\|\.transfer\|\.send" contracts/ && echo "âš ï¸  Review external calls" || echo "âœ… No obvious external calls"

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-audit, solidity-security, gas-optimization, eslint-security, dos-protection-check]
    if: always()

    steps:
      - name: Generate security summary
        run: |
          echo "## Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependency Audit**: ${{ needs.dependency-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Solidity Security**: ${{ needs.solidity-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Gas Optimization**: ${{ needs.gas-optimization.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **JavaScript Security**: ${{ needs.eslint-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DoS Protection**: ${{ needs.dos-protection-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the individual job logs for detailed findings." >> $GITHUB_STEP_SUMMARY
